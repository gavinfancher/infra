---
- name: Setup new VMs with Docker and Tailscale
  hosts: all
  become: false

  vars_files:
    - local_vars.yml

  vars:
    tailscale_auth_key: "{{ lookup('community.general.onepassword', 'tailscale', field='auth-key', vault='infra-secrets') }}"

    target_repo:
      enabled: true
      url: https://github.com/gavinfancher/infra.git
      version: main
      dest: /opt/infra
      scripts:
        - cmd: ./install-docker.sh
          env:
            TARGET_USER: "{{ ansible_user }}"
        - cmd: ./install-tailscale.sh
          env:
            TS_KEY: "{{ tailscale_auth_key }}"
            TS_HOSTNAME: "{{ inventory_hostname }}"

  tasks:
    - name: Install git
      become: true
      ansible.builtin.apt:
        name: git
        state: present
        update_cache: true

    - name: Clone target repo
      become: true
      ansible.builtin.git:
        repo: "{{ target_repo.url }}"
        dest: "{{ target_repo.dest }}"
        version: "{{ target_repo.version }}"
        force: true
      when: target_repo.enabled

    - name: Make scripts executable
      become: true
      ansible.builtin.file:
        path: "{{ target_repo.dest }}/scripts/vm-setup"
        mode: "0755"
        recurse: true
      when: target_repo.enabled

    - name: Run setup scripts
      become: true
      ansible.builtin.command:
        cmd: "{{ item.cmd }}"
        chdir: "{{ target_repo.dest }}/scripts/vm-setup"
      environment: "{{ item.env | default({}) }}"
      loop: "{{ target_repo.scripts }}"
      when: target_repo.enabled
      register: script_results
      changed_when: true

    - name: Clean up cloned repo
      become: true
      ansible.builtin.file:
        path: "{{ target_repo.dest }}"
        state: absent
      when: target_repo.enabled

    - name: Verify setup
      block:
        - name: Check Docker is running
          ansible.builtin.command:
            cmd: docker --version
          register: docker_version
          changed_when: false

        - name: Check Tailscale status
          ansible.builtin.command:
            cmd: tailscale status
          register: tailscale_status
          changed_when: false

        - name: Display results
          ansible.builtin.debug:
            msg:
              - "Docker: {{ docker_version.stdout }}"
              - "Tailscale: {{ tailscale_status.stdout_lines[0] | default('Connected') }}"
